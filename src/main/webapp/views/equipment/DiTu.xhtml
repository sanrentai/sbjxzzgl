<ui:composition xmlns="http://www.w3.org/1999/xhtml"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:p="http://primefaces.org/ui"
                xmlns:pt="http://xmlns.jcp.org/jsf/passthrough"
                xmlns:pe="http://primefaces.org/ui/extensions"
                xmlns:h="http://xmlns.jcp.org/jsf/html">
    <script src="/sbjx/resources/js/BaiDuMap.js"></script>
    <script>
        $(document).ready(function () {
            // 百度地图API功能
            var map = new BMap.Map("Map");    // 创建Map实例
            var mapSetting = $('.mapSetting').first();
            map.centerAndZoom(new BMap.Point(mapSetting.attr('data-initialLongtitude'), mapSetting.attr('data-initialLatitude')),
                    mapSetting.attr('data-zoom'));
            map.addControl(new BMap.MapTypeControl());
            map.enableScrollWheelZoom(false);

            var geo = new BMap.Geocoder();
            $('.uptown').each(function () {
                if ($(this).attr('data-address') !== null) {
                    var countOfListToReply = $(this).attr('data-countOfListToReply');
                    var countOfListToAdd = $(this).attr('data-countOfListToAdd')
                    var blockName = $(this).attr('data-name');
                    geo.getPoint($(this).attr('data-address'), function (point) {
                        if (point) {
                            var marker = new BMap.Marker(point);
                            marker.blockName = blockName;
                            map.addOverlay(marker);
                            var label = new BMap.Label(countOfListToReply, {position: point, offset: new BMap.Size(-5, -25)});
                            label.setStyle({
                                color: "white",
                                fontSize: "12px",
                                height: "20px",
                                lineHeight: "20px",
                                fontFamily: "微软雅黑",
                                background: "none",
                                border: "none"
                            });
                            map.addOverlay(label);
                            marker.addEventListener('click', function (event) {
                                var content = "<div>" + this.blockName + "</div>" + 
                                        "<div>待回复：" + countOfListToReply + "（" + countOfListToAdd + "新）超时：0</div>" + 
                                        "<div>收费类：2</div>" + 
                                        "<div>外网类：3</div>" +
                                        "<div>监察类：1</div>" +
                                        "<div>其它类：0</div>";
                                var infoWindow = new BMap.InfoWindow(content);
                                this.openInfoWindow(infoWindow);
                                console.log(event);
                                return true;
                            });
                        } else {
                            alert("您选择地址没有解析到结果!");
                        }
                    });
                }
            });
            $('.employee').each(function () {
                var pt = new BMap.Point($(this).attr('data-longtitude'), $(this).attr('data-latitude'));
                var myIcon = new BMap.Icon("/sbjx/resources/images/员工标签.png", new BMap.Size(64, 32));
                var marker = new BMap.Marker(pt, {icon: myIcon});
                map.addOverlay(marker);

                var label = new BMap.Label($(this).attr('data-name'), {position: pt, offset: new BMap.Size(-10, -15)});
                label.setStyle({
                    color: "white",
                    fontSize: "12px",
                    height: "20px",
                    lineHeight: "20px",
                    fontFamily: "微软雅黑",
                    background: "none",
                    border: "none"
                });
                map.addOverlay(label);
            });
        });
    </script>
    <p:layout style="min-width:400px;min-height:100%;height:100%;">
        <p:layoutUnit position="west" resizable="false" size="256">
            <p:scrollPanel style="width:87%;height:30%;">
                <p:commandLink>
                    <h:outputText value="新开里8楼2单元823室"/>
                </p:commandLink><br/>
                <p:commandLink>
                    <h:outputText value="新开里9楼2单元923室"/>
                </p:commandLink><br/>
                <p:commandLink>
                    <h:outputText value="新开里10楼2单元1023室"/>
                </p:commandLink><br/>
            </p:scrollPanel>
            <p:scrollPanel style="width:87%;height:30%;">
                <p:dataTable value="#{DiTuController.viewModel.uptownList}" var="uptown">
                    <p:column headerText="小区名">
                        <h:outputText value="#{uptown.name}"/>
                    </p:column>
                    <p:column headerText="新增">
                        <h:outputText value="#{uptown.countOfListToAdd}"/>
                    </p:column>
                    <p:column headerText="待回复">
                        <h:outputText value="#{uptown.countOfListToReply}"/>
                    </p:column>
                </p:dataTable>
            </p:scrollPanel>
            <p:scrollPanel style="width:87%;height:35%;">
                <p:dataTable value="#{DiTuController.viewModel.employeeList}" var="employee">
                    <p:column headerText="维修工">
                        <h:outputText value="#{employee.name}"/>
                    </p:column>
                    <p:column headerText="工单">
                        <h:outputText value="#{employee.countOfWorkList}"/>
                    </p:column>
                    <p:column headerText="电话">
                        <p:commandLink process="@this">
                            <i class="fa fa-phone Fs18 Blue"></i>
                        </p:commandLink>
                    </p:column>
                </p:dataTable>
            </p:scrollPanel>
        </p:layoutUnit>
        <p:layoutUnit position="center">
            <div id="Map" style="width: 100%;height: 100%;overflow: hidden;margin:0;font-family:'微软雅黑';"></div>
        </p:layoutUnit>
    </p:layout>
    <ui:repeat value="#{DiTuController.viewModel.mapSettingList}" var="mapSetting">
        <div class="mapSetting" 
             data-initialLongtitude="#{mapSetting.initialLongtitude}"
             data-initialLatitude="#{mapSetting.initialLatitude}"
             data-zoom="#{mapSetting.zoom}"></div>
    </ui:repeat>
    <ui:repeat value="#{DiTuController.viewModel.uptownList}" var="uptown">
        <div class="uptown" 
             data-countOfListToReply="#{uptown.countOfListToReply}"
             data-countOfListToAdd="#{uptown.countOfListToAdd}"
             data-name="#{uptown.name}" 
             data-address="#{uptown.address}"
             data-longtitude="#{uptown.longtitude}"
             data-latitude="#{uptown.latitude}"/>
    </ui:repeat>
    <ui:repeat value="#{DiTuController.viewModel.employeeList}" var="employee">
        <div class="employee" 
             data-longtitude="#{employee.longtitude}"
             data-latitude="#{employee.latitude}"
             data-name="#{employee.name}"/>
    </ui:repeat>
</ui:composition>